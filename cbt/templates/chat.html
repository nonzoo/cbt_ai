<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Chatbot ‚Ä¢ DOU Exam</title>

  <!-- Tailwind + font (for the new design only) -->
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
  <script>
    tailwind.config = {
      theme: {
        extend: {
          fontFamily: { sans: ['Inter', 'ui-sans-serif', 'system-ui'] },
          colors: {
            brand: {
              50: '#eff6ff', 100: '#dbeafe', 200: '#bfdbfe', 300: '#93c5fd',
              400: '#60a5fa', 500: '#3b82f6', 600: '#2563eb', 700: '#1d4ed8',
              800: '#1e40af', 900: '#1e3a8a'
            }
          }
        }
      }
    }
  </script>
  <style>
    /* ===== your original chat bubble styles (unchanged behavior) ===== */
    #chat-box{
      width:100%;               /* fill the card width */
      height:420px;
      border:1px solid #ccc;
      overflow-y:auto;
      padding:10px;
      margin-bottom:10px;
      background:#fafafa;
      font-family:system-ui,-apple-system,Segoe UI,Roboto,"Helvetica Neue",Arial,"Noto Sans";
      border-radius: 12px;      /* rounded to match card */
      border-color: #e5e7eb;    /* softer border to match design */
    }
    .user-msg,.bot-msg{margin:8px 0;max-width:85%;padding:8px 10px;border-radius:10px;line-height:1.35;white-space:pre-wrap}
    .user-msg{margin-left:auto;background:#d9fdd3;text-align:right}
    .bot-msg{margin-right:auto;background:#fff;border:1px solid #eee}

    /* typing loader */
    .typing{display:inline-flex;gap:3px;align-items:center}
    .dot{width:6px;height:6px;border-radius:50%;background:#999;opacity:.5;animation:blink 1.2s infinite}
    .dot:nth-child(2){animation-delay:.2s}.dot:nth-child(3){animation-delay:.4s}
    @keyframes blink{0%,80%,100%{opacity:.3}40%{opacity:1}}

    /* vertical options list */
    .bot-msg ul.options{list-style:none;padding-left:0;margin:8px 0 0}
    .bot-msg ul.options li{padding:6px 8px;margin:4px 0;border:1px solid #e8e8e8;border-radius:8px;cursor:pointer;user-select:none;transition:.15s}
    .bot-msg ul.options li:hover{background:#f5f5f5}

    /* button row (kept for compatibility, hidden in new header but id stays) */
    .start-row{display:none}
    .start-btn{padding:6px 10px;border:none;background:#2563eb;color:#fff;border-radius:6px;cursor:pointer}
    .start-btn:disabled{opacity:.6;cursor:default}

    /* small focus helper to match Tailwind look */
    .focus-ring:focus-visible { outline: 3px solid rgba(59,130,246,.5); outline-offset: 2px; }
  </style>
</head>

<body class="min-h-screen bg-gradient-to-br from-purple-50 via-sky-50 to-cyan-50 flex items-center justify-center p-4 font-sans">
  <div class="w-full max-w-3xl">
    <!-- Header Card (adds your Start button with same id) -->
    <header class="mb-5">
      <div class="relative overflow-hidden rounded-2xl bg-white/80 backdrop-blur shadow-lg ring-1 ring-purple-100">
        <div class="absolute inset-0 -z-10">
          <svg class="w-full h-full opacity-60" viewBox="0 0 600 200" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
            <defs><linearGradient id="g" x1="0" y1="0" x2="1" y2="1">
              <stop offset="0" stop-color="#93c5fd"/><stop offset="1" stop-color="#22d3ee"/>
            </linearGradient></defs>
            <circle cx="90" cy="70" r="60" fill="url(#g)" opacity="0.25"/>
            <circle cx="300" cy="150" r="80" fill="url(#g)" opacity="0.2"/>
            <circle cx="520" cy="60" r="70" fill="url(#g)" opacity="0.18"/>
          </svg>
        </div>
        <div class="px-6 py-5 md:px-8 md:py-6 flex flex-col md:flex-row md:items-center md:justify-between gap-4">
          <div>
            <div class="flex items-center gap-2">
              <span class="inline-flex items-center gap-2 rounded-full bg-purple-600/10 text-purple-700 px-3 py-1 text-xs font-semibold">
                <span class="w-2 h-2 rounded-full bg-purple-600 animate-pulse"></span>
                Live
              </span>
            </div>
            <h1 class="mt-2 text-2xl md:text-3xl font-bold text-slate-800">Welcome, {{username}}</h1>
            <p class="text-slate-600 mt-1">Your friendly DOU Exam Bot is here to help you practice.</p>
          </div>
          <div class="flex items-center gap-3">
            <!-- same id so your JS keeps working -->
            <button id="start-btn" class="focus-ring inline-flex items-center gap-2 rounded-xl bg-purple-600 text-white font-semibold px-5 py-3 shadow-sm hover:bg-purple-700 active:scale-[0.99] transition" type="button">
              <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 opacity-90" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.8" d="M14.752 11.168l-5.197-3.026A1 1 0 008 9.026v5.948a1 1 0 001.555.832l5.197-3.026a1 1 0 000-1.712z" />
              </svg>
              Start exam
            </button>
          </div>
        </div>
      </div>
    </header>

    <!-- Chat Card -->
    <main class="rounded-2xl bg-white shadow-xl ring-1 ring-purple-100 overflow-hidden">
      <div class="p-4 md:p-6">
        <!-- your original chat box (id preserved) -->
        <div id="chat-box"></div>
      </div>

      <!-- Input Row -->
      <form id="chat-form" class="border-t border-purple-100/70 bg-white px-4 py-3 md:px-5 md:py-4">
        <div class="flex items-end gap-2">
          <div class="flex-1 relative">
            <input id="message-input" type="text" autocomplete="off" placeholder="Type a message..." required
              class="w-full focus-ring rounded-xl border border-slate-200 bg-white px-4 py-3 pr-12 text-slate-800 placeholder-slate-400 shadow-sm focus:border-purple-400" />
            <div class="pointer-events-none absolute right-3 bottom-2.5 text-slate-400">
              <span class="text-xs">Press Enter</span>
            </div>
          </div>
          <button type="submit" class="focus-ring inline-flex items-center justify-center rounded-xl bg-slate-900 text-white px-5 py-3 font-semibold shadow-sm hover:bg-slate-800 active:scale-[0.99] transition">
            Send
          </button>
        </div>
        <p class="mt-2 text-xs text-slate-500">Tip: Type ‚Äústart exam‚Äù or tap the Start button to begin.</p>
      </form>
    </main>
  </div>

  <!-- ===== your original JS (unchanged) ===== -->
  <script>
    // ---- config ----
    const TYPE_DELAY_MS = 18;  // typing speed (lower = faster)

    // ---- globals ----
    const token = '{{ token }}';
    const params = new URLSearchParams(window.location.search);
    const examId = params.get('exam_id'); // optional
    const chatBox = document.getElementById('chat-box');
    const form = document.getElementById('chat-form');
    const input = document.getElementById('message-input');
    const startBtn = document.getElementById('start-btn');

    // greet on load
    appendBotAnimated("üëã Hello! Welcome to the DOU Exam Bot.\nWhen you're ready, type 'start exam' (or click the button above) to begin.");

    startBtn.addEventListener('click', () => {
      startBtn.disabled = true;
      sendMessage('start exam').finally(()=> setTimeout(()=> startBtn.disabled = false, 800));
    });

    // ---------- UI helpers ----------
    function appendUser(text){
      const div = document.createElement('div');
      div.className='user-msg';
      div.textContent=text;
      chatBox.appendChild(div);
      chatBox.scrollTop=chatBox.scrollHeight;
    }

    function makeLoaderBubble(){
      const div=document.createElement('div');
      div.className='bot-msg';
      const wrap=document.createElement('div');
      wrap.className='typing';
      wrap.innerHTML='<span class="dot"></span><span class="dot"></span><span class="dot"></span>';
      div.appendChild(wrap);
      return div;
    }

    function splitOptionsFromText(text){
      const lines=text.split(/\r?\n/);
      const opts=[], stem=[];
      for(const l of lines){
        if(/^\s*[A-D]\.\s+/.test(l)) opts.push(l.trim());
        else stem.push(l);
      }
      return { stem: stem.join('\n').trim(), opts };
    }

    function buildOptionsList(opts){
      const ul=document.createElement('ul');
      ul.className='options';
      opts.forEach(line=>{
        const m=line.match(/^\s*([A-D])\.\s+(.+)$/);
        if(!m) return;
        const li=document.createElement('li');
        li.dataset.letter=m[1];
        li.innerHTML=`<strong>${m[1]}.</strong> ${escapeHtml(m[2])}`;
        ul.appendChild(li);
      });
      return ul;
    }

    function escapeHtml(str){
      return str.replace(/[&<>"]/g, s=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[s]));
    }

    function typeText(el, text){
      return new Promise(resolve=>{
        let i=0, cancelled=false;
        const finish=()=>{ el.textContent=text; resolve(); };
        el.addEventListener('click', ()=>{ cancelled=true; finish(); }, { once:true });
        const tick=()=>{
          if(cancelled) return;
          if(i>=text.length){ resolve(); return; }
          el.textContent += text.charAt(i++);
          chatBox.scrollTop=chatBox.scrollHeight;
          setTimeout(tick, TYPE_DELAY_MS);
        };
        // start
        if(text.length===0){ resolve(); } else { tick(); }
      });
    }

    async function appendBotAnimated(text){
      // create bubble
      const bubble=document.createElement('div');
      bubble.className='bot-msg';
      // content area (typed)
      const content=document.createElement('div');
      bubble.appendChild(content);
      chatBox.appendChild(bubble);
      chatBox.scrollTop=chatBox.scrollHeight;

      // split out options
      const { stem, opts } = splitOptionsFromText(text || '');

      // type the stem first
      await typeText(content, stem || '');

      // then reveal options as vertical list (if present)
      if(opts && opts.length>=2){
        const ul=buildOptionsList(opts);
        bubble.appendChild(ul);
        chatBox.scrollTop=chatBox.scrollHeight;
      }
    }

    // click on an option sends that letter
    chatBox.addEventListener('click', e=>{
      const li=e.target.closest('li[data-letter]');
      if(!li) return;
      input.value=li.dataset.letter;
      form.requestSubmit();
    });

    // ---------- network ----------
    form.addEventListener('submit', (e)=>{
      e.preventDefault();
      const message=input.value.trim();
      if(!message) return;
      input.value='';
      sendMessage(message);
    });

    async function sendMessage(message){
      appendUser(message);

      // show typing loader while waiting for response
      const loader = makeLoaderBubble();
      chatBox.appendChild(loader);
      chatBox.scrollTop = chatBox.scrollHeight;

      try{
        const res = await fetch('http://localhost:5005/webhooks/rest/webhook', {
          method:'POST',
          headers:{ 'Content-Type':'application/json' },
          body: JSON.stringify({
            sender:'user',
            message,
            metadata:{
              access_token: token,
              ...(examId ? { exam_id: examId } : {})
            }
          })
        });

        // remove loader
        loader.remove();

        if(!res.ok){
          await appendBotAnimated(`‚ö†Ô∏è Error contacting the bot (${res.status}).`);
          return;
        }
        const data = await res.json();
        if(!Array.isArray(data) || data.length===0){
          await appendBotAnimated("‚Ä¶ (no response)");
          return;
        }

        // Animate each bot message sequentially
        for(const msg of data){
          if(msg.text) {
            await appendBotAnimated(msg.text);
          }
        }
      }catch(err){
        loader.remove();
        console.error(err);
        await appendBotAnimated("‚ö†Ô∏è Network error. Please try again.");
      }
    }
  </script>
</body>
</html>
